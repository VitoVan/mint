<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<link href="../lib/main.css" rel="stylesheet" />
		<script src="../public/js/jquery.js"></script>
		<script src="../public/js/comm.js"></script>
		<script src="jquery-3.3.1.min.js"></script>
		<script src="julian.js"></script>
		<script src="lune.js"></script>
		<script src="suncalc.js"></script>
		<script src="./planet_position/js/planet-positions.js"></script>

		<script src="../studio/js/fixedsticky.js"></script>
		<script src="../guide/guide.js"></script>
		<link type="text/css" rel="stylesheet" href="../guide/guide.css" />

		<script src="../public/js/marked.js"></script>
		<!--获取语言-->
		<script>
			var g_language = "en";
			var g_currLink = "";
			function lang_init(strPage) {
				g_currLink = strPage;
			}
			function setLang(strLang) {
				g_language = strLang;
				setCookie("language", g_language, 365);
				window.location.assign(location.pathname + "?language=" + g_language);
			}
		</script>
		<script>
			var current_phase = phase();
			console.log(current_phase); //输出到控制台

			//$("#title_text").html(localString[g_language].BE);
			var new_list = new Array(); //新月列表
			var first_list = new Array(); //上弦月列表
			var full_list = new Array(); //满月列表
			var last_list = new Array(); //下弦月列表
			var planets = new Array(); //
			var lunar_position = new Object();

			var g_coordinate_this = new Object();
			var g_now_date = new Date();
			var today = new Date();
			var start_day = new Date();
			var next_year = new Date();
			var sun_times = new Object();

			var curr_position = localStorage.getItem("local_position");
			if (curr_position) {
				g_coordinate_this.AT = curr_position.split("#")[0];
				g_coordinate_this.LT = curr_position.split("#")[1];
				g_coordinate_this.height = curr_position.split("#")[2];
				if (g_coordinate_this.AT >= 0) {
					var AT_string = angle_trans(g_coordinate_this.AT) + "N";
				} else {
					var AT_string = angle_trans(g_coordinate_this.AT) + "S";
				}
				if (g_coordinate_this.LT >= 0) {
					var LT_string = angle_trans(g_coordinate_this.LT) + "E";
				} else {
					var LT_string = angle_trans(g_coordinate_this.LT) + "W";
				}
				let height_string = g_coordinate_this.height + "M";
				$("#selected_position_string").html(AT_string + " " + LT_string + " " + height_string);
			} else {
				getLocation();
			}
			function show_time() {
				if ($("#input_time").val()) {
					today = new Date($("#input_time").val());
				} else {
					today = g_now_date;
				}
				if (phase(today).phase <= 0.5) {
					start_day.setDate(today.getDate() - 16); //退到本月的新月之前
					start_day = phaseHunt(start_day).full_date; //得到之前最近的满月日
					start_day.setDate(start_day.getDate() + 1);
				} else {
					start_day.setDate(today.getDate() - 31); //退到本月的新月之前
					start_day = phaseHunt(start_day).full_date; //得到之前最近的满月日
					start_day.setDate(start_day.getDate() + 1);
				}
				next_year.setDate(start_day.getDate() + 360);

				last_list = phaseRange(start_day, next_year, LAST); //获取下弦月列表
				new_list = phaseRange(start_day, next_year, NEW); //获取新月列表
				first_list = phaseRange(start_day, next_year, FIRST); //获取上弦月列表
				full_list = phaseRange(start_day, next_year, FULL); //获取满月列表

				console.log(last_list); //输出到控制台
				console.log(new_list); //输出到控制台
				console.log(first_list); //输出到控制台
				console.log(full_list); //输出到控制台
				lunar_phase_list_refresh();
				get_position(today);

				let d_earth_to_moon =
					lunar_position.position.x ^
					(2 + lunar_position.position.y) ^
					(2 + lunar_position.position.z) ^
					2 ^
					0.5;
				let d_earth_to_moon_0 = phase(today).distance;

				sun_times = SunCalc.getTimes(
					today,
					g_coordinate_this.AT,
					g_coordinate_this.LT,
					g_coordinate_this.height / 1000
				);
				sun_position = SunCalc.getPosition(today, g_coordinate_this.AT, g_coordinate_this.LT);
				moon_position = SunCalc.getMoonPosition(today, g_coordinate_this.AT, g_coordinate_this.LT);
				moon_Illumination = SunCalc.getMoonIllumination(today);
				$("#today_dawn").html(sun_times.dawn.toLocaleTimeString()); //破晓
				$("#today_solarNoon").html(sun_times.solarNoon.toLocaleTimeString()); //正午
				$("#today_sunset").html(sun_times.sunset.toLocaleTimeString()); //日落
				$("#today_sun_azimuth").html(angle_trans((sun_position.azimuth / Math.PI) * 180)); //太阳水平弧度
				$("#today_moon_azimuth").html(angle_trans((moon_position.azimuth / Math.PI) * 180)); //月亮水平弧度
				$("#today_moon_phase").html(phase(today).phase); //月相值
				$("#today_moon_percent").html(phase(today).illuminated); //月照度
				$("#today_moon_angle").html(angle_trans((moon_Illumination.angle / Math.PI) * 180)); //月相角
				$("#angle_sun_e_moon").html(
					angle_trans((Math.abs(Math.PI + sun_position.azimuth - moon_position.azimuth) / Math.PI) * 180)
				); //月亮水平弧度
				$("#curr_time").html(today.toLocaleTimeString()); //当前时间
				$("#now_time").html(g_now_date.toLocaleTimeString()); //现在
				$("#curr_time_unix").html(today.getTime()); //時間戳

				let earth_angle_string = "";
				earth_angle_string += get_position(today).solar_position_angle + "——";
				earth_angle_string += get_position(today).solar_position_angle_round + "——";
				earth_angle_string += get_position(today).solar_station + "——";
				earth_angle_string += get_station_name(today).solar.icon;
				$("#earth_angle").html(earth_angle_string); //地球角度

				let moon_angle_string = "";
				moon_angle_string += get_position(today).lunar_position_angle + "——";
				moon_angle_string += get_position(today).lunar_position_angle_round + "——";
				moon_angle_string += get_position(today).lunar_station + "——";
				moon_angle_string += get_station_name(today).lunar.value;
				$("#moon_angle").html(moon_angle_string); //月亮角度——角度差算法

				let moon_angle_string2 = "";
				moon_angle_string2 += get_position(today).lunar_position_angle2 + "——";
				moon_angle_string2 += get_position(today).lunar_position_angle_round2 + "——";
				moon_angle_string2 += get_position(today).lunar_station2 + "——";
				moon_angle_string2 += get_station_name(today).lunar.value;
				$("#moon_angle2").html(moon_angle_string2); //月亮角度——向量差算法
			}
			//根据时间计算偏角，输出
			function get_position(date_time) {
				let planets_position = new Object();
				planets = window.lagrange.planet_positions.getPositions(date_time);
				//planets = global.planet_positions.getPositions(today);
				//console.log(planets)//输出到控制台
				earth_position = window.lagrange.planet_positions.getPositions(date_time)[3];
				lunar_position = window.lagrange.planet_positions.getPositions(date_time)[11];
				let lunar_position_angle = 0;
				let lunar_station = 0;
				let earth_position_angle = 0;
				let earth_station = 0;
				let earth_position_angle_round = 0;
				let lunar_position_angle_round = 0;
				//太阳相对地球的黄道偏角
				if (earth_position.position.y >= 0) {
					earth_position_angle = Math.atan2(earth_position.position.y, earth_position.position.x);
				} else {
					earth_position_angle =
						Math.PI * 2 + Math.atan2(earth_position.position.y, earth_position.position.x);
				}
				earth_position_angle_round = earth_position_angle / Math.PI / 2 + 0.5;
				earth_position_angle_round = earth_position_angle_round - Math.floor(earth_position_angle_round);
				earth_station = earth_position_angle_round * 12;
				planets_position.solar_station = earth_station;
				planets_position.solar_position_angle = earth_position_angle_round * Math.PI * 2;
				planets_position.solar_position_angle_round = earth_position_angle_round;
				//月球相对地球的黄道偏角——角度差算法
				lunar_position_angle_round = earth_position_angle_round + phase(date_time).phase;
				lunar_position_angle_round = lunar_position_angle_round - Math.floor(lunar_position_angle_round);
				lunar_position_angle = lunar_position_angle_round * Math.PI * 2;
				lunar_station = lunar_position_angle_round * 27;
				//月球相对地球的黄道偏角算法——向量差算法
				let lunar_to_earth = new Object();
				lunar_to_earth.y = lunar_position.position.y - earth_position.position.y;
				lunar_to_earth.x = lunar_position.position.x - earth_position.position.x;
				if (lunar_to_earth.y >= 0) {
					lunar_position_angle2 = Math.atan2(lunar_to_earth.y, lunar_to_earth.x);
				} else {
					lunar_position_angle2 = Math.PI * 2 + Math.atan2(lunar_to_earth.y, lunar_to_earth.x);
				}
				lunar_position_angle_round2 = lunar_position_angle2 / Math.PI / 2;
				//lunar_position_angle_round = lunar_position_angle_round - Math.floor(lunar_position_angle_round)
				lunar_position_angle2 = lunar_position_angle_round2 * Math.PI * 2;

				lunar_station2 = lunar_position_angle_round2 * 27;

				planets_position.lunar_station = lunar_station; //月站值【角度差算夹角】
				planets_position.lunar_position_angle = lunar_position_angle; //月站角【角度差算夹角】
				planets_position.lunar_position_angle_round = lunar_position_angle_round; //月站圆周比率【角度差算夹角】
				planets_position.lunar_station2 = lunar_station2; //月站值【矢量差算夹角】
				planets_position.lunar_position_angle2 = lunar_position_angle2; //月站角【矢量差算夹角】
				planets_position.lunar_position_angle_round2 = lunar_position_angle_round2; //月站圆周比率【矢量差算夹角】
				return planets_position;
			}
			//根据;
			function get_station_name(data_time) {
				//获取星象信息
				let solar_num = 0;
				let lunar_num = 0;
				solar_num = get_position(data_time).solar_station;
				solar_num = Math.floor(solar_num);
				lunar_num = get_position(data_time).lunar_station;
				lunar_num = Math.floor(lunar_num);

				let result = new Object();
				result.solar = horoscope_name[solar_num]; //黄道十二宫星象名称
				result.lunar = pali_nakkhatta_name[lunar_num]; //27星宿月站名称
				return result;
			}
			function getLocation() {
				//自动定位
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(showPosition, showError);
				} else {
					$("#selected_position_string").html("Geolocation is not supported by this browser.");
				}
			}
			function showPosition(position) {
				alert("get cordinate success");
				g_coordinate_this.AT = position.coords.latitude; //纬度
				g_coordinate_this.LT = position.coords.longitude; //经度
				g_coordinate_this.height = position.coords.altitude; //海拔高度
				//手动输入
				var LT = Number($("#LT_°")[0].value);
				LT += Number($("#LT_’")[0].value) / 60;
				LT += Number($("#LT_”")[0].value) / 3600;
				LT = Number($("#WE")[0].value + LT);
				var AT = Number($("#AT_°")[0].value);
				AT += Number($("#AT_’")[0].value) / 60;
				AT += Number($("#AT_”")[0].value) / 3600;
				AT = Number($("#NS")[0].value + AT);
				if (AT != 0) {
					g_coordinate_this.LT = LT;
					g_coordinate_this.AT = AT;
				}

				let position_string =
					g_coordinate_this.AT + "#" + g_coordinate_this.LT + "#" + g_coordinate_this.height;
				localStorage.setItem("local_position", position_string);

				if (g_coordinate_this.AT >= 0) {
					var AT_string = angle_trans(g_coordinate_this.AT) + "N";
				} else {
					var AT_string = angle_trans(g_coordinate_this.AT) + "S";
				}
				if (g_coordinate_this.LT >= 0) {
					var LT_string = angle_trans(g_coordinate_this.LT) + "E";
				} else {
					var LT_string = angle_trans(g_coordinate_this.LT) + "W";
				}
				let height_string = g_coordinate_this.height + "M";
				$("#selected_position_string").html(AT_string + " " + LT_string + " " + height_string);
				$("#position_input").hide();
			}
			function showError(error) {
				switch (error.code) {
					case error.PERMISSION_DENIED:
						alert("定位失败,用户拒绝请求地理定位");
						break;
					case error.POSITION_UNAVAILABLE:
						alert("定位失败,位置信息是不可用");
						break;
					case error.TIMEOUT:
						alert("定位失败,请求获取用户位置超时");
						break;
					case error.UNKNOWN_ERROR:
						alert("定位失败,定位系统失效");
						break;
				}
			}
			function angle_trans(angle) {
				var angle_str = "";
				var num_d = Math.floor(angle);
				var num_m = Math.floor((angle - num_d) * 60);
				var num_s = Math.round((angle - num_d) * 60 - num_m);
				if (num_d != 0) {
					angle_str += num_d + "°";
				}
				if (num_m != 0) {
					angle_str += num_m + "’";
				}
				if (num_s != 0) {
					angle_str += num_s + "”";
				}
				return angle_str;
			}
			function input_position() {
				$("#position_input").show();
			}
			var g_event_list_arr = new Array();
			function get_event_arr() {
				let from_str = new Date();
				let info_obj = new Object();
			}
		</script>
		<script src="../lib/main.js"></script>
		<script>
			function getCookie(name) {
				var start = document.cookie.indexOf(name + "=");
				var len = start + name.length + 1;
				if (!start && name != document.cookie.substring(0, name.length)) {
					return null;
				}
				if (start == -1) return null;
				var end = document.cookie.indexOf(";", len);
				if (end == -1) end = document.cookie.length;
				return decodeURI(document.cookie.substring(len, end));
			}

			document.addEventListener("DOMContentLoaded", function () {
				var initialTimeZone = "local";
				var timeZoneSelectorEl = document.getElementById("time-zone-selector");
				var loadingEl = document.getElementById("loading");
				var calendarEl = document.getElementById("calendar");

				var calendar = new FullCalendar.Calendar(calendarEl, {
					timeZone: initialTimeZone,
					locale: getCookie("language"),
					headerToolbar: {
						left: "prev,next today",
						center: "title",
						right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek",
					},
					//initialDate: "2020-12-12",
					navLinks: true, // can click day/week names to navigate views
					editable: true,
					selectable: true,
					dayMaxEvents: true, // allow "more" link when too many events
					resources: g_event_list_arr,
					events: {
						/*url: "php/get-events.php",
							failure: function () {
								document.getElementById("script-warning").style.display = "inline"; // show
							},*/
					},
					eventClick: function (info) {
						info.jsEvent.preventDefault(); // don't let the browser navigate

						if (info.event.url) {
							window.open(info.event.url);
						}
					},

					loading: function (bool) {
						if (bool) {
							loadingEl.style.display = "inline"; // show
						} else {
							loadingEl.style.display = "none"; // hide
						}
					},

					eventTimeFormat: { hour: "numeric", minute: "2-digit" },

					dateClick: function (arg) {
						console.log("dateClick", calendar.formatIso(arg.date));
					},
					select: function (arg) {
						console.log("select", calendar.formatIso(arg.start), calendar.formatIso(arg.end));
					},
				});

				calendar.render();

				// load the list of available timezones, build the <select> options
				// it's HIGHLY recommended to use a different library for network requests, not this internal util func
				FullCalendar.requestJson(
					"GET",
					"php/get-time-zones.php",
					{},
					function (timeZones) {
						timeZones.forEach(function (timeZone) {
							var optionEl;

							if (timeZone !== "UTC") {
								// UTC is already in the list
								optionEl = document.createElement("option");
								optionEl.value = timeZone;
								optionEl.innerText = timeZone;
								timeZoneSelectorEl.appendChild(optionEl);
							}
						});
					},
					function () {
						// TODO: handle error
					}
				);

				// when the timezone selector changes, dynamically change the calendar option
				timeZoneSelectorEl.addEventListener("change", function () {
					calendar.setOption("timeZone", this.value);
				});
			});
		</script>
		<style>
			body {
				margin: 0;
				padding: 0;
				font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
				font-size: 14px;
			}

			#top {
				background: #eee;
				border-bottom: 1px solid #ddd;
				padding: 0 10px;
				line-height: 40px;
				font-size: 12px;
			}
			.left {
				float: left;
			}
			.right {
				float: right;
			}
			.clear {
				clear: both;
			}

			#script-warning,
			#loading {
				display: none;
			}
			#script-warning {
				font-weight: bold;
				color: red;
			}

			#calendar {
				max-width: 1100px;
				margin: 40px auto;
				padding: 0 10px;
			}

			.tzo {
				color: #000;
			}
		</style>
	</head>
	<body>
		<div id="top">
			<div class="left">
				Timezone:
				<select id="time-zone-selector">
					<option value="local" selected>local</option>
					<option value="UTC">UTC</option>
				</select>
			</div>

			<div class="right">
				<span id="loading">loading...</span>
				<span id="script-warning"><code>php/get-events.php</code> must be running.</span>
			</div>

			<div class="clear"></div>
		</div>

		<div id="calendar"></div>
	</body>
</html>
